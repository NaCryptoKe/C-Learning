<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Byteforge Chronicles: C++ Quests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#007ACC', // C++ Blue
                        'secondary': '#FFD700', // Gold/MP Color
                        'dark-bg': '#1e293b', // Slate-800
                        'dark-card': '#334155', // Slate-700
                        'accent': '#FF6B6B', // Red for achievements
                        'success': '#4ADE80', // Green for completion
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-gentle': 'bounce-gentle 2s infinite',
                        'level-up': 'level-up 0.5s ease-out',
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%, 100%': { boxShadow: '0 0 5px rgba(0, 122, 204, 0.5)' },
                            '50%': { boxShadow: '0 0 20px rgba(0, 122, 204, 0.8)' }
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        'bounce-gentle': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' }
                        },
                        'level-up': {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.2)', opacity: '0.8' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap');
        body {
            background-color: #0f172a; /* Slate-900 */
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 122, 204, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.1) 0%, transparent 20%);
        }
        .container {
            max-width: 1200px;
        }
        .quest-header {
            background-color: #1e293b;
            border-left: 5px solid #007ACC;
            position: relative;
            overflow: hidden;
        }
        .quest-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #007ACC, transparent);
        }
        .task-item-base {
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .task-item-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        .task-item-base.completed {
            background-color: #166534; /* Dark Green */
            border-left: 4px solid #4ade80; /* Light Green */
            cursor: pointer;
        }
        .task-item-base.completed:hover {
            background-color: #15803d;
        }
        .task-item-base.locked {
            filter: grayscale(80%) brightness(0.6);
        }
        .section-header {
            color: #cbd5e1;
        }
        /* Custom Scrollbar for better dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Achievement badges */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #334155, #1e293b);
            border: 1px solid #475569;
            border-radius: 20px;
            padding: 6px 12px;
            margin: 4px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        .achievement-badge.earned {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }
        
        /* XP Bar */
        .xp-bar {
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, #007ACC, #00C9FF);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        /* Game notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            border-left: 4px solid #007ACC;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            border-left-color: #10b981;
        }
        .notification.level-up {
            border-left-color: #f59e0b;
            animation: pulse-glow 1s infinite;
        }
        
        /* Character avatar */
        .character-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #334155, #1e293b);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #007ACC;
            transition: all 0.3s ease;
            position: relative;
        }
        .character-avatar.level-up {
            animation: level-up 0.5s ease-out;
            border-color: #f59e0b;
        }
        
        /* Skill tree visualization */
        .skill-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            border: 2px solid #475569;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .skill-node.unlocked {
            background: #007ACC;
            border-color: #00C9FF;
            box-shadow: 0 0 10px rgba(0, 122, 204, 0.5);
        }
        .skill-node.completed {
            background: #10b981;
            border-color: #34d399;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        /* Quest completion animation */
        @keyframes questComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(16, 185, 129, 0.7); }
            100% { transform: scale(1); }
        }
        .quest-complete {
            animation: questComplete 0.5s ease-out;
        }
    </style>
</head>
<body class="p-4">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary mx-auto"></div>
            <p class="mt-4 text-xl font-semibold text-primary">Forging the Chronicles...</p>
        </div>
    </div>

    <!-- Game Notifications -->
    <div id="notification-area"></div>

    <div class="container mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 bg-dark-card p-6 rounded-xl shadow-2xl relative overflow-hidden">
            <!-- Animated background elements -->
            <div class="absolute top-0 left-0 w-20 h-20 bg-primary/10 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-secondary/10 rounded-full translate-x-1/2 translate-y-1/2"></div>
            
            <div class="flex flex-col md:flex-row items-center justify-between mb-6">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <div id="character-avatar" class="character-avatar">
                        <span class="text-2xl">üë®‚Äçüíª</span>
                    </div>
                    <div class="text-left">
                        <h1 class="text-4xl font-extrabold text-secondary">The Byteforge Chronicles</h1>
                        <p class="text-lg text-gray-400 mt-2">A Structured, RPG-Style Roadmap to C++ Mastery</p>
                    </div>
                </div>
                
                <div class="flex flex-col items-center">
                    <div class="text-center mb-2">
                        <span class="text-gray-400">Next Level:</span>
                        <span class="font-bold text-secondary ml-2" id="next-level-mp">0 MP</span>
                    </div>
                    <div class="xp-bar w-48 mb-1">
                        <div id="xp-progress" class="xp-progress" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-gray-400" id="xp-text">0/0 XP</div>
                </div>
            </div>

            <div id="status-bar" class="mt-6 flex flex-col md:flex-row justify-center items-center gap-4">
                <div class="flex items-center space-x-2 p-3 bg-dark-bg rounded-lg shadow-inner animate-pulse-glow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3 .895-3 2c0 1.105 1.343 2 3 2m0-8V9m0 3v1m0 3v1M5 16h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2z" />
                    </svg>
                    <span class="text-2xl font-bold text-secondary" id="total-mp">0 MP</span>
                </div>
                
                <div class="flex items-center space-x-2 p-3 bg-dark-bg rounded-lg shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5 5.103 5 3 6.57 3 8.5c0 1.455.77 2.99 2.14 4.053l3.66 2.843 2.68-1.55-2.68-1.55 3.66-2.843C16.23 9.49 17 8.545 17 7.5c0-1.93-2.103-3.5-4.5-3.5C11.754 4 10.168 4.477 9 5.253" />
                    </svg>
                    <span class="text-xl font-semibold text-primary" id="current-rank">Apprentice Coder</span>
                </div>

                 <div class="flex items-center space-x-2 p-3 bg-dark-bg rounded-lg shadow-inner text-sm">
                    <span class="text-gray-400">User ID:</span>
                    <span class="text-xs font-mono text-gray-300" id="user-id">Loading...</span>
                </div>
                <div class="flex items-center space-x-2 p-3 bg-dark-bg rounded-lg shadow-inner text-sm">
                    <span class="text-gray-400">Last Updated:</span>
                    <span class="text-xs font-mono text-gray-300" id="last-updated">Never</span>
                </div>
            </div>
            <div id="progress-overview" class="mt-4">
                <div class="w-full bg-dark-bg rounded-full h-2.5">
                    <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-400 mt-1"><span id="completed-tasks-count">0</span> of <span id="total-tasks-count">0</span> tasks completed</p>
            </div>
            
            <!-- Achievements Preview -->
            <div id="achievements-preview" class="mt-6 flex flex-wrap justify-center gap-2">
                <!-- Achievements will be dynamically added here -->
            </div>
        </header>

        <!-- Game Stats & Character Panel -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Character Stats -->
            <div class="p-4 bg-dark-card rounded-xl shadow-2xl">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">üë§ Character Stats</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Level:</span>
                        <span class="font-bold text-secondary" id="character-level">1</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Total XP:</span>
                        <span class="font-bold" id="total-xp">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Quests Completed:</span>
                        <span class="font-bold text-success" id="quests-completed">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Days Active:</span>
                        <span class="font-bold" id="days-active">1</span>
                    </div>
                </div>
            </div>
            
            <!-- Skills Progress -->
            <div class="p-4 bg-dark-card rounded-xl shadow-2xl">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">üõ†Ô∏è Skills Progress</h3>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-400">Core C++</span>
                            <span class="text-xs text-gray-400" id="core-cpp-progress">0%</span>
                        </div>
                        <div class="w-full bg-dark-bg rounded-full h-2">
                            <div id="core-cpp-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-400">STL & Libraries</span>
                            <span class="text-xs text-gray-400" id="stl-progress">0%</span>
                        </div>
                        <div class="w-full bg-dark-bg rounded-full h-2">
                            <div id="stl-bar" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-gray-400">Concurrency</span>
                            <span class="text-xs text-gray-400" id="concurrency-progress">0%</span>
                        </div>
                        <div class="w-full bg-dark-bg rounded-full h-2">
                            <div id="concurrency-bar" class="bg-success h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Achievements -->
            <div class="p-4 bg-dark-card rounded-xl shadow-2xl">
                <h3 class="text-xl font-bold text-primary mb-4 text-center">üèÜ Recent Achievements</h3>
                <div id="recent-achievements" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm">No achievements yet</p>
                </div>
            </div>
        </div>

        <!-- Guidelines & Information Section -->
        <div class="mb-8 p-6 bg-dark-card rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-primary mb-4">üìú Guidelines & Information</h2>
            <div class="space-y-3 text-gray-300">
                <p><strong><span class="text-secondary">Quest Completion:</span></strong> Click on a task to view its details. Once you've completed the requirements, mark it as "COMPLETE" in the modal. This action is manual and based on an honor system.</p>
                <p><strong><span class="text-secondary">AI-Powered Validation:</span></strong> Each task provides a pre-formatted prompt. Copy this prompt, paste your C++ code into it, and submit it to a capable AI (like Gemini or GPT-4) for validation. The AI will act as your mentor, confirming if your code is correct and granting the MP reward.</p>
                <p><strong><span class="text-secondary">Mastery Points (MP):</span></strong> Completing tasks earns you Mastery Points (MP). Accumulating MP allows you to advance through the ranks, showcasing your growing expertise in C++.</p>
                <p><strong><span class="text-secondary">Prerequisites:</span></strong> Quests and tasks are designed to be completed in order. A task will remain locked until the one preceding it is marked as complete. This ensures a structured and logical learning path.</p>
                <p><strong><span class="text-secondary">Ranks:</span></strong> Your rank reflects your total MP. Strive to reach the highest rank, "Grand Master C++," by completing all available quests.</p>
                <p><strong><span class="text-secondary">User ID & Progress:</span></strong> Your progress is saved automatically and tied to your unique User ID. You can return at any time and pick up where you left off.</p>
            </div>
        </div>

        <!-- Quest List -->
        <div id="quests-list" class="space-y-8">
            <!-- Quests will be rendered here -->
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
            <!-- Rank Progression Table -->
            <div class="p-6 bg-dark-card rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold text-primary mb-4 text-center">üèÜ Rank Progression</h2>
                <div id="ranks-table" class="overflow-x-auto">
                    <!-- Ranks will be dynamically generated here -->
                </div>
            </div>
            <!-- Leaderboard -->
            <div class="p-6 bg-dark-card rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold text-secondary mb-4 text-center">üåü Leaderboard</h2>
                <div id="leaderboard" class="overflow-x-auto">
                    <!-- Leaderboard will be dynamically generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Task Details and Prompt -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-dark-card rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
            <div class="p-6 max-h-[90vh] overflow-y-auto">
                <h3 id="modal-title" class="text-2xl font-bold text-secondary mb-2"></h3>
                <span id="modal-mp" class="inline-block px-3 py-1 text-sm font-semibold bg-secondary text-dark-bg rounded-full mb-4"></span>
                
                <p id="modal-description" class="text-gray-300 mb-4"></p>
                
                <h4 class="text-lg font-semibold text-green-400 mt-4 mb-2">üí° What You'll Learn</h4>
                <ul id="modal-learning" class="list-disc pl-5 text-gray-300 space-y-1">
                    <!-- Learning objectives will be populated here -->
                </ul>

                <h4 class="text-lg font-semibold text-yellow-400 mt-6 mb-2">üì¶ What to Deliver</h4>
                <ul id="modal-deliverables" class="list-disc pl-5 text-gray-300 space-y-1">
                    <!-- Deliverables will be populated here -->
                </ul>

                <h4 class="text-lg font-semibold text-primary mt-6 mb-2">‚úÖ Checklist</h4>
                <ul id="modal-tasks" class="list-disc pl-5 text-gray-300 space-y-1">
                    <!-- Tasks to be populated -->
                </ul>

                <h4 class="text-lg font-semibold text-primary mt-6 mb-2">ü§ñ AI Check Prompt</h4>
                <div class="bg-dark-bg p-3 rounded-lg border border-primary/50">
                    <p id="modal-prompt" class="font-mono text-sm whitespace-pre-wrap text-gray-200"></p>
                    <button onclick="copyToClipboard(document.getElementById('modal-prompt').innerText)" class="mt-3 w-full bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                        Copy Prompt & Code Template
                    </button>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <button id="modal-toggle-complete" class="px-5 py-2 rounded-lg font-bold text-white transition duration-300">
                        Mark as Complete
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCmdQ9QJaF6n5Ecuk9C9swoZZrcvpv0vCY",
            authDomain: "byteforge-chronicles.firebaseapp.com",
            projectId: "byteforge-chronicles",
            storageBucket: "byteforge-chronicles.appspot.com",
            messagingSenderId: "314939412929",
            appId: "1:314939412929:web:7525d68d2e51c3bb141f40",
            measurementId: "G-FRZ0TXYW6M"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        let db, auth, userId = null;
        let gameState = { completedTasks: {}, lastUpdate: null };
        
        setLogLevel('Debug');

        const QUESTS_DATA = [
            { id: 'I', title: 'The Core Foundation: Cinder of Creation', mp_goal: 3000, sections: [
                { id: 'IA', title: 'Basic Spells & Syntax', prereq: 'None ‚Äî you begin your journey here.', sections: [
                    { id: 'IA1', name: 'The Hello World Rite', mp: 200, desc: 'Summon your first program and control its output.', 
                        tasks: ['Install a compiler (g++ or clang)', 'Write and run Hello World', 'Understand .cpp file structure'],
                        learning: ['The basic structure of a C++ program, including the `main` function.', 'How to print text to the console using `std::cout`.', 'How to compile and run your code from the command line or an IDE.'],
                        deliverables: ['A single `.cpp` file that, when compiled and run, prints "Hello, World!" to the console.', 'Your code pasted into the AI Check Prompt for validation.'],
                        checkPrompt: 'I completed "The Hello World Rite". Please review this simple C++ program and confirm if I correctly displayed output and followed basic file structure. If correct, grant the 200 MP reward.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IA2', name: 'Data Tamer‚Äôs Initiation', mp: 200, desc: 'Learn types, variables, and operators.', 
                        tasks: ['Use all primitive types', 'Experiment with implicit/explicit casting', 'Perform arithmetic and logical ops'],
                        learning: ['The purpose of fundamental data types (`int`, `double`, `char`, `bool`).', 'How to declare, initialize, and assign values to variables.', 'The function of arithmetic, relational, and logical operators.'],
                        deliverables: ['A `.cpp` file demonstrating the use of at least four different data types and three different operator types (e.g., +, >, &&).', 'Comments in your code explaining a case of implicit and explicit type casting.'],
                        checkPrompt: 'I completed "Data Tamer‚Äôs Initiation". Here is a C++ snippet demonstrating the use of all primitive types, casting, and basic operators. Please confirm its correctness and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IA3', name: 'Flow of Control Incantations', mp: 200, desc: 'Harness conditionals and loops.', 
                        tasks: ['Implement an if/else ladder', 'Use for, while, and do-while', 'Solve FizzBuzz & factorial using loops'],
                        learning: ['How to direct program flow with `if`, `else if`, and `else` statements.', 'The difference and use cases for `for`, `while`, and `do-while` loops.', 'How to solve classic programming problems using iterative logic.'],
                        deliverables: ['A `.cpp` file containing two functions: one that solves the FizzBuzz problem, and another that calculates a factorial using a loop of your choice.'],
                        checkPrompt: 'I completed "Flow of Control Incantations". I have implemented the FizzBuzz problem and a factorial calculator using different loop types. Please review the control flow logic and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IA4', name: 'Function & Scope Mastery', mp: 200, desc: 'Divide your magic into reusable forms.', 
                        tasks: ['Write functions that pass by value/ref', 'Use global vs local scope correctly', 'Implement recursion safely'],
                        learning: ['How to write modular, reusable code with functions.', 'The critical difference between pass-by-value and pass-by-reference.', 'Variable scope (local vs. global) and the concept of a call stack.'],
                        deliverables: ['A `.cpp` file with three functions: one demonstrating pass-by-value, one for pass-by-reference, and one safe recursive function (e.g., factorial with a base case).'],
                        checkPrompt: 'I completed "Function & Scope Mastery". Please review the following functions, paying attention to value/reference passing and the use of scopes. I also included a safe recursive function example. Grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]},
                { id: 'IB', title: 'Object-Oriented Alchemy', prereq: 'Basic Spells & Syntax completed.', sections: [
                    { id: 'IB1', name: 'Class Blueprinting', mp: 300, desc: 'Create structs, classes, and understand access control.', 
                        tasks: ['Create a Player or Weapon class', 'Use private/public members', 'Implement constructors'],
                        learning: ['The core concept of Object-Oriented Programming: encapsulating data and behavior.', 'How to define a class with member variables and functions.', 'The role of `public` and `private` access specifiers and constructors.'],
                        deliverables: ['A header file (`.h`) and a source file (`.cpp`) defining a simple `Player` or `Weapon` class with at least two private member variables and two public member functions, including a constructor.'],
                        checkPrompt: 'I completed "Class Blueprinting". Here is my C++ class definition (Player or Weapon). Please confirm proper use of private/public members and constructors. Grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IB2', name: 'The Rule of Five Trial', mp: 300, desc: 'Master memory control in OOP.', 
                        tasks: ['Implement copy/move ctor & assignment', 'Understand destructor order', 'Explain deep vs shallow copy'],
                        learning: ['Why manual memory management is sometimes necessary.', 'The specific roles of the destructor, copy/move constructors, and copy/move assignment operators.', 'The concept of resource ownership and how to perform a "deep copy".'],
                        deliverables: ['A class that manages a raw pointer and correctly implements all five special member functions (the "Rule of Five").'],
                        checkPrompt: 'I completed "The Rule of Five Trial". I implemented a class demonstrating the Rule of Five (copy/move constructor/assignment, destructor) with proper memory handling (deep copy). Please review and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IB3', name: 'Inheritance & Abstraction Path', mp: 300, desc: 'Build a hierarchy of entities.', 
                        tasks: ['Create a base Entity class', 'Derive subclasses', 'Use virtual functions'],
                        learning: ['How to create "is-a" relationships using public inheritance.', 'The concept of polymorphism and how `virtual` functions enable it.', 'The difference between compile-time and run-time binding.'],
                        deliverables: ['A base class (e.g., `Entity`) with at least one `virtual` function, and two derived classes (e.g., `Player`, `Enemy`) that override the virtual function to provide specialized behavior.'],
                        checkPrompt: 'I completed "Inheritance & Abstraction Path". Please review the class hierarchy I created, including a base Entity class and derived subclasses. Confirm correct use of virtual functions and polymorphism. Grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IB4', name: 'Template Forging', mp: 300, desc: 'Summon generic classes & functions.', 
                        tasks: ['Create a templated swap() function', 'Create a templated Vector<T> mini-class'],
                        learning: ['How templates enable writing generic, type-agnostic code.', 'How to create function templates for algorithms.', 'How to create class templates for data structures.'],
                        deliverables: ['A `.cpp` file containing a function template `swap<T>()` and a basic class template `Pair<T>` that can hold two objects of any type.'],
                        checkPrompt: 'I completed "Template Forging". I implemented a templated swap function and a basic templated Vector<T> class. Please check the generic code structure and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]},
                { id: 'IC', title: 'The Memory Shaper', prereq: 'Object-Oriented Alchemy complete.', sections: [
                    { id: 'IC1', name: 'Stack vs Heap Duel', mp: 300, desc: 'Learn where and how memory lives.', 
                        tasks: ['Allocate data on stack/heap', 'Visualize call stack and memory layout'],
                        learning: ['The difference between automatic (stack) and dynamic (heap) memory allocation.', 'The role of `new` and `delete` operators for heap management.', 'The risks of memory leaks and dangling pointers.'],
                        deliverables: ['A program that allocates a simple object on the stack and another on the heap. Include comments explaining the lifetime of each object.'],
                        checkPrompt: 'I completed "Stack vs Heap Duel". Here is a C++ code snippet and a brief explanation (in comments) of where its variables are allocated (stack vs. heap). Please review and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IC2', name: 'The RAII Principle', mp: 300, desc: 'Manage resources safely via constructors/destructors.', 
                        tasks: ['Build a FileHandler class that opens/closes a file safely'],
                        learning: ['The concept of Resource Acquisition Is Initialization (RAII).', 'How to write exception-safe code by tying resource lifetime to object lifetime.', 'The fundamental idea behind smart pointers.'],
                        deliverables: ['A simple class that acquires a resource in its constructor (like opening a file with `fopen`) and releases it in its destructor (with `fclose`), demonstrating the RAII principle.'],
                        checkPrompt: 'I completed "The RAII Principle". I created a FileHandler class that uses RAII to guarantee the file is closed in the destructor, even on exceptions. Please confirm the principle is correctly applied. Grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IC3', name: 'Unique Pointer Path', mp: 200, desc: 'Use smart pointers to prevent leaks.', 
                        tasks: ['Implement with std::unique_ptr', 'Replace raw pointers safely'],
                        learning: ['How `std::unique_ptr` provides exclusive ownership of a heap-allocated object.', 'How `std::unique_ptr` automatically cleans up memory, preventing leaks.', 'How to use `std::make_unique` for safer allocation.'],
                        deliverables: ['Refactor the code from the "Stack vs Heap Duel" quest to use `std::unique_ptr` instead of `new` and `delete` for the heap-allocated object.'],
                        checkPrompt: 'I completed "Unique Pointer Path". I refactored a class to exclusively use std::unique_ptr instead of raw pointers to manage heap memory. Please confirm leak prevention and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IC4', name: 'Shared & Weak Pointer Mastery', mp: 200, desc: 'Model complex ownership.', 
                        tasks: ['Build an object graph using shared_ptr/weak_ptr', 'Detect and prevent cycles'],
                        learning: ['How `std::shared_ptr` allows for shared ownership of a resource.', 'How reference counting works to manage the resource\'s lifetime.', 'The purpose of `std::weak_ptr` in breaking cyclical dependencies.'],
                        deliverables: ['A program demonstrating a potential circular reference using two classes holding `std::shared_ptr` to each other, and then show how `std::weak_ptr` resolves the issue.'],
                        checkPrompt: 'I completed "Shared & Weak Pointer Mastery". I created an object graph (e.g., Parent/Child) using std::shared_ptr and std::weak_ptr to prevent reference cycles and leaks. Please check the ownership logic and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]}
            ]},
            { id: 'II', title: 'The Modern Arsenal: Standard Library & Idioms', mp_goal: 2000, sections: [
                { id: 'IIA', title: 'STL Containers', prereq: 'Core Foundation completed.', sections: [
                    { id: 'IIA1', name: 'Sequential Mastery', mp: 300, desc: 'Master vector, string, deque.', 
                        tasks: ['Store and iterate over objects', 'Benchmark push/pop performance'],
                        learning: ['The properties and common use cases of `std::vector`, `std::string`, and `std::deque`.', 'How to add, access, and iterate over elements in sequential containers.', 'Basic performance characteristics (e.g., `vector` reallocation).'],
                        deliverables: ['A program that creates a `std::vector` of a custom struct, adds several elements, and iterates over them to print their values.'],
                        checkPrompt: 'I completed "Sequential Mastery". I implemented a small program demonstrating the basic use of std::vector, std::string, and std::deque. I also included a comment on their respective push/pop performance characteristics. Grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIA2', name: 'Associative Mastery', mp: 300, desc: 'Learn map, set, and unordered variants.', 
                        tasks: ['Implement frequency counter', 'Benchmark lookup speeds'],
                        learning: ['The difference between ordered (`map`, `set`) and unordered (`unordered_map`, `unordered_set`) associative containers.', 'How to use key-value pairs for efficient data lookup.', 'The performance trade-offs between tree-based and hash-based containers.'],
                        deliverables: ['A function that takes a `std::string` and returns a `std::unordered_map<char, int>` counting the frequency of each character in the string.'],
                        checkPrompt: 'I completed "Associative Mastery". I used std::unordered_map to implement a word frequency counter and compared its lookup speed conceptually with std::map. Please confirm correct usage and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]},
                { id: 'IIB', title: 'STL Algorithms', prereq: 'None', sections: [
                    { id: 'IIB1', name: 'Algorithmic Sage', mp: 400, desc: 'Replace raw loops with STL algorithms.', 
                        tasks: ['Replace loops with STL functions', 'Use lambdas in algorithms', 'Implement a mini functional pipeline'],
                        learning: ['How to use the `<algorithm>` header to write more expressive and efficient code.', 'The power of iterators in defining ranges for algorithms.', 'How to use lambda expressions to provide custom logic to algorithms like `std::sort`, `std::find_if`, and `std::transform`.'],
                        deliverables: ['A program that takes a `std::vector<int>`, sorts it, removes all even numbers, and then transforms the remaining numbers (e.g., squares them), using only STL algorithms and lambdas instead of raw loops.'],
                        checkPrompt: 'I completed "Algorithmic Sage". I replaced three traditional loops with std::sort, std::find, and std::transform, utilizing a lambda function within one of them. Please check the code for idiomatic usage and grant 400 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]},
                { id: 'IIC', title: 'C++17 Artifacts', prereq: 'None', sections: [
                    { id: 'IIC1', name: 'Structured Binding Seer', mp: 200, desc: 'Simplify tuple/pair unpacking.', 
                        tasks: ['Use structured bindings with maps', 'Implement if(init; cond) syntax'],
                        learning: ['How to cleanly unpack values from pairs, tuples, and structs using structured bindings.', 'How to declare variables within `if` and `switch` statements to limit their scope.'],
                        deliverables: ['A code snippet that iterates over a `std::map` and uses a structured binding `[key, value]` to access its elements.', 'A separate `if` statement demonstrating the `if (initializer; condition)` syntax.'],
                        checkPrompt: 'I completed "Structured Binding Seer". I demonstrated the use of structured bindings to unpack a std::map element and utilized the `if(init; cond)` statement for scope control. Please review and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIC2', name: 'Type-Safe Union Mastery', mp: 200, desc: 'Use optional, variant, and any.', 
                        tasks: ['Replace null with std::optional', 'Handle multiple states with variant'],
                        learning: ['How `std::optional` provides a type-safe way to represent a value that may or may not exist.', 'How `std::variant` provides a type-safe union for storing one of a list of possible types.', 'How to safely access the values within these types using `std::visit` or helper functions.'],
                        deliverables: ['A function that returns `std::optional<int>` to indicate success/failure.', 'A second example using `std::variant` to hold either an `int` or a `std::string`, and `std::visit` to process it.'],
                        checkPrompt: 'I completed "Type-Safe Union Mastery". I used std::optional for a return value that might fail, and used std::variant/std::visit to handle a type-safe object with multiple states. Please review and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIC3', name: 'Filesystem Voyager', mp: 200, desc: 'Explore directories programmatically.', 
                        tasks: ['Use std::filesystem to iterate files', 'Implement a recursive file lister'],
                        learning: ['How to interact with the host operating system\'s file system in a portable way.', 'How to create, inspect, and iterate through directory paths and files.', 'The basics of the `std::filesystem::path` object.'],
                        deliverables: ['A function that takes a path as a string and recursively prints all the files and directories within it to the console.'],
                        checkPrompt: 'I completed "Filesystem Voyager". I implemented a function using std::filesystem that recursively lists all files in a given directory path. Please review the implementation and grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]},
                { id: 'IID', title: 'C++20 Legendary Gear', prereq: 'None', sections: [
                    { id: 'IID1', name: 'Concepts Apprentice', mp: 150, desc: 'Apply template constraints.', 
                        tasks: ['Write a constrained template', 'Create your own Number concept'],
                        learning: ['How C++20 Concepts improve template error messages and readability.', 'How to define a `concept` to specify requirements for a template type parameter.', 'How to use `requires` clauses to constrain templates.'],
                        deliverables: ['A custom `concept` (e.g., `Integral` or `Printable`).', 'A function template that is constrained by the concept you created.'],
                        checkPrompt: 'I completed "Concepts Apprentice". I wrote a function template constrained by a custom-defined C++20 concept (e.g., `Number`). Please confirm the constraint correctly limits the template\'s usage. Grant 150 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IID2', name: 'Ranges Adept', mp: 150, desc: 'Use the Ranges library for clean iteration.', 
                        tasks: ['Implement transformations with pipes', 'Compare to loops'],
                        learning: ['How the Ranges library provides a more functional and composable way to work with sequences of data.', 'How to use the pipe `|` operator to chain views and actions.', 'The concepts of lazy evaluation in range adaptors.'],
                        deliverables: ['A code snippet that uses a range pipeline to filter and transform elements from a `std::vector`, for example, taking all even numbers and squaring them.'],
                        checkPrompt: 'I completed "Ranges Adept". I used C++20 ranges and pipe operators to perform a sequence of transformations (e.g., filter, transform, take) on a container. Please compare its readability to a traditional loop and grant 150 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IID3', name: 'Coroutines Initiate', mp: 100, desc: 'Learn async functions.', 
                        tasks: ['Write a basic coroutine (generator style)'],
                        learning: ['The basic idea of coroutines for writing asynchronous, non-blocking code.', 'The roles of `co_await`, `co_yield`, and `co_return`.', 'How coroutines can simplify complex asynchronous logic like generators or async I/O.'],
                        deliverables: ['A simple generator function implemented as a coroutine that uses `co_yield` to produce a sequence of numbers.'],
                        checkPrompt: 'I completed "Coroutines Initiate". I wrote a basic C++20 coroutine used as a generator (using `co_yield`) to produce a sequence of values. Please review the coroutine structure and grant 100 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]}
            ]},
            { id: 'III', title: 'The System Engineer: OS & Concurrency', mp_goal: 2000, sections: [
                { id: 'IIIA', title: 'Thread & Concurrency Master', prereq: 'STL mastery.', sections: [
                    { id: 'IIIA1', name: 'Thread Spawner', mp: 300, desc: 'Create threads that execute functions.', 
                        tasks: ['Spawn 3 threads printing numbers'],
                        learning: ['How to create and launch new threads of execution using `std::thread`.', 'The importance of joining threads to wait for their completion.', 'How to pass arguments to functions running on new threads.'],
                        deliverables: ['A program that spawns two threads, each running a function that prints a different message to the console. The main thread must wait for both to finish before exiting.'],
                        checkPrompt: 'I completed "Thread Spawner". I wrote a program that successfully spawns three separate `std::thread` objects, each executing a function that prints a range of numbers. Please review and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIIA2', name: 'Mutex Guardian', mp: 300, desc: 'Prevent data races.', 
                        tasks: ['Implement thread-safe counter'],
                        learning: ['What a "data race" is and why it\'s a critical bug in concurrent programming.', 'How to use `std::mutex` to protect a shared resource from simultaneous access.', 'The practice of locking a mutex before accessing shared data and unlocking it after.'],
                        deliverables: ['A program where multiple threads increment a single shared counter. Use a `std::mutex` to ensure the final count is correct and not corrupted by race conditions.'],
                        checkPrompt: 'I completed "Mutex Guardian". I implemented a thread-safe counter class using `std::mutex` to protect the critical section (the counter variable) from data races. Please confirm thread safety and grant 300 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIIA3', name: 'Condition Conjurer', mp: 200, desc: 'Synchronize via condition vars.', 
                        tasks: ['Build producer-consumer model'],
                        learning: ['How to use `std::condition_variable` to make threads wait for a specific condition to become true.', 'The relationship between a condition variable and a mutex.', 'How to avoid spurious wakeups when waiting on a condition.'],
                        deliverables: ['A simple "producer-consumer" program. One thread (the producer) adds items to a queue, and another thread (the consumer) waits using a condition variable until the queue is not empty before processing an item.'],
                        checkPrompt: 'I completed "Condition Conjurer". I implemented a basic Producer-Consumer model using `std::mutex` and `std::condition_variable` to synchronize threads accessing a shared queue. Please confirm proper signaling and waiting. Grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' },
                    { id: 'IIIA4', name: 'Atomic Adept', mp: 200, desc: 'Learn lock-free atomic ops.', 
                        tasks: ['Implement spinlock counter'],
                        learning: ['What atomic operations are and when they can be used as a faster alternative to mutexes.', 'How `std::atomic` can be used for simple, thread-safe operations like incrementing a counter.', 'The concept of memory ordering (`memory_order_relaxed`, `memory_order_seq_cst`, etc.).'],
                        deliverables: ['Reimplement the thread-safe counter from the "Mutex Guardian" quest using `std::atomic<int>` instead of a `std::mutex`.'],
                        checkPrompt: 'I completed "Atomic Adept". I implemented a simple lock-free counter using `std::atomic<int>` or a custom spinlock using `std::atomic_flag`. Please review the lock-free synchronization. Grant 200 MP.\n\n```cpp\n// [Paste Code Here]\n```' }
                ]}
            ]},
        ];

        const ALL_TASKS = {};
        let totalTasksCount = 0;
        QUESTS_DATA.forEach(quest => {
            quest.sections.forEach(topSection => {
                topSection.sections.forEach(task => {
                    ALL_TASKS[task.id] = task;
                    totalTasksCount++;
                });
            });
        });
        document.getElementById('total-tasks-count').textContent = totalTasksCount;

        const RANKS = [
            { mp: 0, title: 'Apprentice Coder', description: 'Learns syntax and logic.' },
            { mp: 1501, title: 'Journeyman Developer', description: 'Masters OOP & STL.' },
            { mp: 4001, title: 'Senior Engineer', description: 'Masters concurrency & networking.' },
            { mp: 7001, title: 'Archmage of Systems', description: 'Creates complex, robust systems.' },
            { mp: 10001, title: 'Grand Master C++', description: 'Commands the entire C++ ecosystem.' }
        ];

        // ACHIEVEMENTS SYSTEM
        const ACHIEVEMENTS = [
            { id: 'first_quest', name: 'First Steps', description: 'Complete your first quest', icon: 'üöÄ', earned: false },
            { id: 'core_master', name: 'Core Foundations', description: 'Complete all Core Foundation quests', icon: 'üîß', earned: false },
            { id: 'stl_expert', name: 'STL Expert', description: 'Complete all STL quests', icon: 'üìö', earned: false },
            { id: 'concurrency_guru', name: 'Concurrency Guru', description: 'Complete all concurrency quests', icon: '‚ö°', earned: false },
            { id: 'halfway_there', name: 'Halfway There', description: 'Complete 50% of all quests', icon: 'üéØ', earned: false },
            { id: 'master_coder', name: 'Master Coder', description: 'Reach Senior Engineer rank', icon: 'üë®‚Äçüíª', earned: false },
            { id: 'week_streak', name: 'Week Streak', description: 'Complete quests for 7 consecutive days', icon: 'üî•', earned: false },
            { id: 'perfectionist', name: 'Perfectionist', description: 'Complete a quest with all bonus objectives', icon: '‚≠ê', earned: false },
        ];

        // GAME ENHANCEMENTS
        let gameStats = {
            level: 1,
            xp: 0,
            xpToNextLevel: 100,
            questsCompleted: 0,
            daysActive: 1,
            lastActiveDate: new Date().toDateString(),
            achievements: {},
            skills: {
                coreCpp: 0,
                stl: 0,
                concurrency: 0
            }
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        startListeningForState();
                        fetchLeaderboard(); 
                    } else {
                        console.error("No user signed in.");
                    }
                    document.getElementById('loading-overlay').classList.add('hidden');
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-xl text-red-500">FATAL ERROR: ${error.message}. Check console for details.</p>`;
            }
        }

        function startListeningForState() {
            if (!db || !userId) return;

            const statePath = `artifacts/${appId}/public/data/cpp_quests_users/${userId}`;
            const stateDocRef = doc(db, statePath);

            onSnapshot(stateDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    gameState = docSnap.data();
                    if (gameState.gameStats) {
                        gameStats = { ...gameStats, ...gameState.gameStats };
                    }
                } else {
                    gameState = { completedTasks: {}, lastUpdate: null, totalMp: 0, gameStats: gameStats };
                    setDoc(stateDocRef, gameState).catch(e => console.error("Error setting initial doc:", e));
                }
                
                // Check if it's a new day
                const today = new Date().toDateString();
                if (gameStats.lastActiveDate !== today) {
                    gameStats.daysActive++;
                    gameStats.lastActiveDate = today;
                    showNotification("New day! Your daily streak continues!", "success");
                }
                
                updateUI();
                updateGameStatsUI();
            }, (error) => {
                console.error("Error listening to game state:", error);
            });
        }

        async function saveGameState() {
            if (!db || !userId) return;
            const statePath = `artifacts/${appId}/public/data/cpp_quests_users/${userId}`;
            const stateDocRef = doc(db, statePath);
            const totalMp = calculateTotalMP();
            try {
                await setDoc(stateDocRef, {
                    completedTasks: gameState.completedTasks,
                    lastUpdate: new Date(),
                    totalMp: totalMp,
                    userId: userId,
                    gameStats: gameStats
                }, { merge: true });
                console.log("Game state saved successfully.");
                fetchLeaderboard();
            } catch (e) {
                console.error("Error saving game state:", e);
            }
        }
        
        async function fetchLeaderboard() {
            if (!db) return;
            const leaderboardContainer = document.getElementById('leaderboard');
            leaderboardContainer.innerHTML = '<p class="text-center">Loading leaderboard...</p>';

            try {
                const usersCollection = collection(db, `artifacts/${appId}/public/data/cpp_quests_users`);
                const q = query(usersCollection, orderBy("totalMp", "desc"), limit(10));
                
                const querySnapshot = await getDocs(q);
                let leaderboardHtml = `
                    <table class="min-w-full divide-y divide-secondary/20">
                        <thead class="bg-secondary/20">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-secondary">Rank</th>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-secondary">User ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-secondary">MP</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-dark-bg">`;

                if (querySnapshot.empty) {
                    leaderboardHtml = '<p class="text-center text-gray-400">No players on the leaderboard yet. Be the first!</p>';
                } else {
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const isCurrentUser = data.userId === userId;
                        leaderboardHtml += `
                            <tr class="${isCurrentUser ? 'bg-primary/20 font-bold' : 'hover:bg-dark-bg'}">
                                <td class="px-4 py-2 whitespace-nowrap">${rank++}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-xs font-mono">${data.userId.substring(0, 12)}...</td>
                                <td class="px-4 py-2 whitespace-nowrap font-bold text-secondary">${data.totalMp || 0}</td>
                            </tr>
                        `;
                    });
                     leaderboardHtml += `</tbody></table>`;
                }
                leaderboardContainer.innerHTML = leaderboardHtml;

            } catch(error) {
                console.error("Error fetching leaderboard:", error);
                leaderboardContainer.innerHTML = '<p class="text-center text-red-500">Could not load leaderboard.</p>';
            }
        }

        function isTaskCompleted(taskId) {
            return gameState.completedTasks && gameState.completedTasks[taskId];
        }

        function isTopSectionCompleted(topSection) {
            return topSection.sections.every(task => isTaskCompleted(task.id));
        }

        function isAvailable(index, list, checkCompletionFn) {
            if (index === 0) return true;
            const previousItem = list[index - 1];
            return checkCompletionFn(previousItem);
        }

        function updateUI() {
            renderRanksTable();
            renderQuests();
            updateStatusBar();
            checkAchievements();
        }

        function calculateTotalMP() {
            let total = 0;
            if (gameState.completedTasks) {
                for (const taskId in gameState.completedTasks) {
                    if (gameState.completedTasks[taskId] && ALL_TASKS[taskId]) {
                        total += ALL_TASKS[taskId].mp;
                    }
                }
            }
            return total;
        }

        function getCurrentRank(mp) {
            let currentRank = RANKS[0];
            for (const rank of RANKS) {
                if (mp >= rank.mp) {
                    currentRank = rank;
                } else {
                    break;
                }
            }
            return currentRank;
        }

        function updateStatusBar() {
            const totalMp = calculateTotalMP();
            const currentRank = getCurrentRank(totalMp);
            
            document.getElementById('total-mp').textContent = `${totalMp} MP`;
            document.getElementById('current-rank').textContent = currentRank.title;

            if (gameState.lastUpdate && gameState.lastUpdate.toDate) {
                const date = gameState.lastUpdate.toDate();
                document.getElementById('last-updated').textContent = date.toLocaleString();
            }

            const completedCount = gameState.completedTasks ? Object.keys(gameState.completedTasks).filter(k => gameState.completedTasks[k]).length : 0;
            document.getElementById('completed-tasks-count').textContent = completedCount;
            const progressPercentage = totalTasksCount > 0 ? (completedCount / totalTasksCount) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
        }
        
        function updateGameStatsUI() {
            document.getElementById('character-level').textContent = gameStats.level;
            document.getElementById('total-xp').textContent = gameStats.xp;
            document.getElementById('quests-completed').textContent = gameStats.questsCompleted;
            document.getElementById('days-active').textContent = gameStats.daysActive;
            
            // Update XP bar
            const xpPercent = (gameStats.xp / gameStats.xpToNextLevel) * 100;
            document.getElementById('xp-progress').style.width = `${Math.min(xpPercent, 100)}%`;
            document.getElementById('xp-text').textContent = `${gameStats.xp}/${gameStats.xpToNextLevel} XP`;
            document.getElementById('next-level-mp').textContent = `${gameStats.xpToNextLevel} XP`;
            
            // Update skill bars
            updateSkillBars();
            
            // Update achievements
            updateAchievementsUI();
        }

        function updateSkillBars() {
            // Calculate skill percentages based on completed quests
            const coreQuests = ['IA1', 'IA2', 'IA3', 'IA4', 'IB1', 'IB2', 'IB3', 'IB4', 'IC1', 'IC2', 'IC3', 'IC4'];
            const stlQuests = ['IIA1', 'IIA2', 'IIB1', 'IIC1', 'IIC2', 'IIC3', 'IID1', 'IID2', 'IID3'];
            const concurrencyQuests = ['IIIA1', 'IIIA2', 'IIIA3', 'IIIA4'];
            
            const completedCore = coreQuests.filter(id => isTaskCompleted(id)).length;
            const completedStl = stlQuests.filter(id => isTaskCompleted(id)).length;
            const completedConcurrency = concurrencyQuests.filter(id => isTaskCompleted(id)).length;
            
            const corePercent = (completedCore / coreQuests.length) * 100;
            const stlPercent = (completedStl / stlQuests.length) * 100;
            const concurrencyPercent = (completedConcurrency / concurrencyQuests.length) * 100;
            
            document.getElementById('core-cpp-bar').style.width = `${corePercent}%`;
            document.getElementById('stl-bar').style.width = `${stlPercent}%`;
            document.getElementById('concurrency-bar').style.width = `${concurrencyPercent}%`;
            
            document.getElementById('core-cpp-progress').textContent = `${Math.round(corePercent)}%`;
            document.getElementById('stl-progress').textContent = `${Math.round(stlPercent)}%`;
            document.getElementById('concurrency-progress').textContent = `${Math.round(concurrencyPercent)}%`;
            
            // Update game stats
            gameStats.skills.coreCpp = corePercent;
            gameStats.skills.stl = stlPercent;
            gameStats.skills.concurrency = concurrencyPercent;
        }

        function updateAchievementsUI() {
            const previewContainer = document.getElementById('achievements-preview');
            const recentContainer = document.getElementById('recent-achievements');
            
            let previewHtml = '';
            let recentHtml = '';
            let earnedCount = 0;
            
            // Get recently earned achievements (last 3)
            const earnedAchievements = ACHIEVEMENTS.filter(a => gameStats.achievements[a.id]);
            earnedCount = earnedAchievements.length;
            
            // Update preview with up to 5 achievements
            earnedAchievements.slice(0, 5).forEach(achievement => {
                previewHtml += `
                    <div class="achievement-badge earned" title="${achievement.description}">
                        <span class="mr-1">${achievement.icon}</span>
                        <span>${achievement.name}</span>
                    </div>
                `;
            });
            
            // Add placeholder for unearned achievements
            if (earnedCount < 5) {
                for (let i = 0; i < 5 - earnedCount; i++) {
                    previewHtml += `
                        <div class="achievement-badge" title="Locked achievement">
                            <span class="mr-1">üîí</span>
                            <span>???</span>
                        </div>
                    `;
                }
            }
            
            // Update recent achievements (last 3 earned)
            if (earnedAchievements.length > 0) {
                earnedAchievements.slice(-3).reverse().forEach(achievement => {
                    recentHtml += `
                        <div class="achievement-badge earned">
                            <span class="mr-1">${achievement.icon}</span>
                            <span>${achievement.name}</span>
                        </div>
                    `;
                });
            } else {
                recentHtml = '<p class="text-center text-gray-500 text-sm">No achievements yet</p>';
            }
            
            previewContainer.innerHTML = previewHtml;
            recentContainer.innerHTML = recentHtml;
        }

        function checkAchievements() {
            const totalTasks = Object.keys(ALL_TASKS).length;
            const completedTasks = gameState.completedTasks ? 
                Object.keys(gameState.completedTasks).filter(k => gameState.completedTasks[k]).length : 0;
            const completionPercent = (completedTasks / totalTasks) * 100;
            
            const totalMp = calculateTotalMP();
            const currentRank = getCurrentRank(totalMp);
            
            // Check each achievement condition
            ACHIEVEMENTS.forEach(achievement => {
                if (gameStats.achievements[achievement.id]) return; // Already earned
                
                let earned = false;
                
                switch(achievement.id) {
                    case 'first_quest':
                        earned = completedTasks >= 1;
                        break;
                    case 'core_master':
                        const coreQuests = ['IA1', 'IA2', 'IA3', 'IA4', 'IB1', 'IB2', 'IB3', 'IB4', 'IC1', 'IC2', 'IC3', 'IC4'];
                        earned = coreQuests.every(id => isTaskCompleted(id));
                        break;
                    case 'stl_expert':
                        const stlQuests = ['IIA1', 'IIA2', 'IIB1', 'IIC1', 'IIC2', 'IIC3', 'IID1', 'IID2', 'IID3'];
                        earned = stlQuests.every(id => isTaskCompleted(id));
                        break;
                    case 'concurrency_guru':
                        const concurrencyQuests = ['IIIA1', 'IIIA2', 'IIIA3', 'IIIA4'];
                        earned = concurrencyQuests.every(id => isTaskCompleted(id));
                        break;
                    case 'halfway_there':
                        earned = completionPercent >= 50;
                        break;
                    case 'master_coder':
                        earned = currentRank.title === 'Senior Engineer' || 
                                currentRank.title === 'Archmage of Systems' || 
                                currentRank.title === 'Grand Master C++';
                        break;
                    case 'week_streak':
                        earned = gameStats.daysActive >= 7;
                        break;
                    case 'perfectionist':
                        // This would require additional tracking of bonus objectives
                        // For now, we'll use a simple heuristic
                        earned = completedTasks >= 5 && 
                                Object.values(gameStats.achievements).filter(a => a).length >= 3;
                        break;
                }
                
                if (earned && !gameStats.achievements[achievement.id]) {
                    gameStats.achievements[achievement.id] = true;
                    showAchievementNotification(achievement);
                }
            });
        }

        function showAchievementNotification(achievement) {
            showNotification(
                `Achievement Unlocked: ${achievement.name}! ${achievement.icon}`,
                "success"
            );
            
            // Add visual flourish
            const avatar = document.getElementById('character-avatar');
            avatar.classList.add('level-up');
            setTimeout(() => {
                avatar.classList.remove('level-up');
            }, 1000);
        }

        function showNotification(message, type = "info") {
            const notificationArea = document.getElementById('notification-area');
            const notificationId = 'notification-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? '‚úÖ' : type === 'level-up' ? 'üéâ' : '‚ÑπÔ∏è'}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function addXP(amount) {
            gameStats.xp += amount;
            
            // Check for level up
            while (gameStats.xp >= gameStats.xpToNextLevel) {
                gameStats.xp -= gameStats.xpToNextLevel;
                gameStats.level++;
                gameStats.xpToNextLevel = Math.floor(gameStats.xpToNextLevel * 1.5); // Increase XP needed for next level
                
                showNotification(`Level Up! You are now Level ${gameStats.level}`, "level-up");
            }
            
            updateGameStatsUI();
            saveGameState();
        }

        function renderRanksTable() {
            const container = document.getElementById('ranks-table');
            let html = `
                <table class="min-w-full divide-y divide-primary/20 rounded-lg overflow-hidden">
                    <thead class="bg-primary/20">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-primary">Title</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-primary">MP Range</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-primary">Description</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-dark-bg">
            `;

            const totalMp = calculateTotalMP();

            for (let i = 0; i < RANKS.length; i++) {
                const rank = RANKS[i];
                const nextMp = RANKS[i+1] ? RANKS[i+1].mp - 1 : '‚àû';
                const isCurrent = (totalMp >= rank.mp) && (i === RANKS.length - 1 || totalMp < RANKS[i+1].mp);
                
                let rangeText = `${rank.mp.toLocaleString()} ‚Äì ${nextMp.toLocaleString()} MP`;
                if (nextMp === '‚àû') {
                    rangeText = `${rank.mp.toLocaleString()}+ MP`;
                }

                html += `
                    <tr class="${isCurrent ? 'bg-secondary/10 font-bold text-secondary' : 'hover:bg-dark-bg'}">
                        <td class="px-6 py-4 whitespace-nowrap">${rank.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${rangeText}</td>
                        <td class="px-6 py-4">${rank.description}</td>
                    </tr>
                `;
            }

            html += `
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }

        function renderQuests() {
            const listContainer = document.getElementById('quests-list');
            listContainer.innerHTML = ''; 

            QUESTS_DATA.forEach(quest => {
                let questHtml = `
                    <div class="quest-block">
                        <div class="quest-header p-4 rounded-lg shadow-xl mb-4">
                            <h2 class="text-2xl font-bold text-primary">${quest.id}. ${quest.title}</h2>
                            <p class="text-sm text-gray-400">Goal: ${quest.mp_goal.toLocaleString()} MP</p>
                        </div>
                `;

                quest.sections.forEach((topSection, topSectionIndex) => {
                    const isSectionAvailable = isAvailable(topSectionIndex, quest.sections, isTopSectionCompleted);
                    const sectionLockClass = isSectionAvailable ? '' : 'opacity-50 pointer-events-none';

                    questHtml += `
                        <div class="top-section ml-4 border-l-2 border-gray-600 pl-4 mb-6 ${sectionLockClass}">
                            <h3 class="section-header text-xl font-semibold mb-2">${topSection.id}. ${topSection.title}</h3>
                            <p class="text-xs text-gray-500 mb-4">Prerequisite: ${topSection.prereq || 'None'}</p>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    `;
                    
                    topSection.sections.forEach((task, taskIndex) => {
                        const isPreviousTaskCompleted = isTaskCompleted(topSection.sections[taskIndex - 1]?.id);
                        const isFirstTask = taskIndex === 0;
                        const isTaskAvailable = isSectionAvailable && (isFirstTask || isPreviousTaskCompleted);
                        const isCompleted = isTaskCompleted(task.id);
                        
                        let itemClass = 'task-item-base';
                        let clickHandler = '';
                        let statusText = isCompleted ? 'COMPLETE' : 'PENDING';
                        let icon = isCompleted ? '‚úÖ' : 'üìú';
                        let overlay = '';

                        if (isCompleted) {
                            itemClass += ' completed';
                            clickHandler = `onclick="openModal('${task.id}')"`;
                        } else if (isTaskAvailable) {
                            itemClass += ' bg-dark-card border-l-4 border-primary/50 task-item-hover';
                            clickHandler = `onclick="openModal('${task.id}')"`;
                        } else {
                            itemClass += ' locked bg-dark-card cursor-not-allowed border-l-4 border-gray-500';
                            statusText = 'LOCKED';
                            icon = 'üîí';
                            clickHandler = '';
                        }

                        questHtml += `
                            <div class="${itemClass} p-4 rounded-lg shadow-md flex justify-between items-center" 
                                 ${clickHandler} data-task-id="${task.id}">
                                <div>
                                    <p class="text-lg font-semibold">${icon} ${task.name}</p>
                                    <p class="text-xs text-gray-400 mt-1">${task.desc}</p>
                                </div>
                                <div class="text-right flex flex-col items-end">
                                    <span class="text-secondary font-bold text-lg">${task.mp} MP</span>
                                    <span class="text-xs font-mono mt-1 ${isCompleted ? 'text-green-300' : isTaskAvailable ? 'text-yellow-400' : 'text-red-400'}">${statusText}</span>
                                </div>
                                ${overlay}
                            </div>
                        `;
                    });

                    questHtml += `</div></div>`;
                });

                questHtml += `</div>`;
                listContainer.innerHTML += questHtml;
            });
        }

        function findTaskById(taskId) {
            for (const quest of QUESTS_DATA) {
                for (const topSection of quest.sections) {
                    for (const task of topSection.sections) {
                        if (task.id === taskId) {
                            return task;
                        }
                    }
                }
            }
            return null;
        }

        window.openModal = function(taskId) {
            let taskData = ALL_TASKS[taskId];
            if (!taskData) return;

            const modal = document.getElementById('task-modal');
            const wrapper = document.getElementById('modal-content-wrapper');
            const isCompleted = isTaskCompleted(taskId);
            
            document.getElementById('modal-title').textContent = `${taskData.id}: ${taskData.name}`;
            document.getElementById('modal-mp').textContent = `${taskData.mp} MP`;
            document.getElementById('modal-description').textContent = taskData.desc;
            document.getElementById('modal-prompt').textContent = taskData.checkPrompt;

            document.getElementById('modal-learning').innerHTML = (taskData.learning || []).map(l => `<li>${l}</li>`).join('');
            document.getElementById('modal-deliverables').innerHTML = (taskData.deliverables || []).map(d => `<li>${d}</li>`).join('');
            document.getElementById('modal-tasks').innerHTML = (taskData.tasks || []).map(t => `<li>${t}</li>`).join('');

            const toggleButton = document.getElementById('modal-toggle-complete');
            if (isCompleted) {
                toggleButton.textContent = 'Mark as PENDING';
                toggleButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                toggleButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            } else {
                toggleButton.textContent = 'Mark as COMPLETE';
                toggleButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                toggleButton.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            toggleButton.onclick = () => toggleTaskCompletion(taskId);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                wrapper.classList.remove('scale-95', 'opacity-0');
                wrapper.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeModal = function() {
            const modal = document.getElementById('task-modal');
            const wrapper = document.getElementById('modal-content-wrapper');

            wrapper.classList.remove('scale-100', 'opacity-100');
            wrapper.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        window.toggleTaskCompletion = async function(taskId) {
            const isCompleted = isTaskCompleted(taskId);
            if (!gameState.completedTasks) {
                gameState.completedTasks = {};
            }
            // Toggle state: if it exists and is true, set to false. Otherwise, set to true.
            gameState.completedTasks[taskId] = !isCompleted;
            
            // Handle game stats for completion
            if (!isCompleted) {
                // Task was just completed
                const task = findTaskById(taskId);
                if (task) {
                    addXP(task.mp);
                    gameStats.questsCompleted++;
                }
                checkAchievements();
                
                // Show completion effect
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('quest-complete');
                    setTimeout(() => {
                        taskElement.classList.remove('quest-complete');
                    }, 1000);
                }
            } else {
                // Task was just uncompleted
                gameStats.questsCompleted = Math.max(0, gameStats.questsCompleted - 1);
            }
            
            await saveGameState();
            closeModal();
        }

        window.copyToClipboard = function(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            const button = document.querySelector('#modal-content-wrapper button.mt-3');
            const originalText = button.textContent;
            button.textContent = 'COPIED!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 1500);
        }

        // Initialize the enhanced game
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading overlay initially
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            // Initialize Firebase and game state
            initFirebase().then(() => {
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }, 1000);
            });
        });

        // Mock leaderboard for demonstration
        function updateLeaderboard() {
            const leaderboardData = [
                { name: 'CodeWizard42', level: 15, mp: 1250 },
                { name: 'CppMaster', level: 12, mp: 980 },
                { name: 'ByteForger', level: 10, mp: 750 },
                { name: 'You', level: gameStats.level, mp: calculateTotalMP() },
                { name: 'SyntaxSlinger', level: 8, mp: 620 },
                { name: 'PointerPro', level: 7, mp: 540 },
            ];
            
            // Sort by MP (descending)
            leaderboardData.sort((a, b) => b.mp - a.mp);
            
            const leaderboardHtml = leaderboardData.map((user, index) => {
                const isCurrentUser = user.name === 'You';
                return `
                    <div class="flex items-center justify-between p-3 ${isCurrentUser ? 'bg-primary/20 rounded-lg' : ''}">
                        <div class="flex items-center">
                            <span class="font-bold w-6 text-center">${index + 1}</span>
                            <span class="ml-3 font-medium ${isCurrentUser ? 'text-secondary' : ''}">${user.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">${user.mp} MP</div>
                            <div class="text-xs text-gray-400">Level ${user.level}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboard').innerHTML = leaderboardHtml;
        }

        // Call this when the game loads
        setTimeout(updateLeaderboard, 2000);
    </script>
</body>
</html>